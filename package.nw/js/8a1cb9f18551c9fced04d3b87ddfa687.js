;!function(require, directRequire){;"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const path=require("path"),fs=require("fs"),zlib=require("zlib"),mkdir=require("mkdir-p"),log=require('./72653d4b93cdd7443296229431a7aa9a.js'),request=require('./15ba1827c7f6564a45df6bd44da3a977.js'),baseRequest=require('./233d77ecf0781f44985f684f70e316d0.js'),urlConfig=require('./f171257bbcaef547a3cf27266ccb0db2.js'),dirConfig=require('./92320c1386e6db6a6f2556736a9bc280.js'),idepluginManager=require('./f5a748840b272d2bf0223c95f6c8dbe3.js'),tools=require('./84b183688a46c9e2626d3e6f83365e13.js'),unpack=require('./514d358c669501bba65151a1ad61ae2f.js'),store=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),report=require('./da7c31daaf542cf1796023d8e344b98a.js'),pluginActions=require('./fb43c40eddf059d0b7fa2a00b42caa7a.js'),signature_1=require('./c3cff51847d72be47e57256891296359.js'),CHECK_INTERVAL=600000;let loopTimer=null,downloadLock=!1;const downloaded={};async function getOnlinePluginList(){const a={url:urlConfig.getPluginList,needToken:1},{body:b}=await request(a);return store.dispatch(pluginActions.setOnlinePluginManifests(b.plugin_list)),b.plugin_list}exports.getOnlinePluginList=getOnlinePluginList;async function doCheckUpdate(){const a=await getOnlinePluginList();handleRequestResult(a)}function gunzipPack(a){return new Promise((b,c)=>{zlib.gunzip(a,(a,d)=>{a?c(a):b(d)})})}async function handleRequestResult(a){const b=idepluginManager.getInstalledPluginManifest();for(const c of a){const a=c.deleted||-1===tools.compareSemVer(global.appVersion,c.min_devtool_version);if(a)continue;const d=b[c.plugin_id];if(d){const a=1===tools.compareSemVer(c.version,d.version),b=!downloaded[c.plugin_id]||!downloaded[c.plugin_id][c.version];if(a&&b)try{await downloadPlugin(c),await installPlugin(c),reportPluginUpdate(c.plugin_id)}catch(a){log.error(a)}}}}function reportPluginUpdate(a){report(`update_plugin_${a}`,!0)}exports.reportPluginUpdate=reportPluginUpdate;function downloadPlugin(a){const b=`${a.plugin_id}_${a.version}.wxpkg`,c=path.join(dirConfig.WeappApplication,b);return new Promise(async(b,d)=>{if(downloadLock)return d(new Error("download is locked"));downloadLock=!0;const e=baseRequest({url:a.download_url,encoding:null},(b)=>{if(downloadLock=!1,b){const c=`downloadPlugin ${a.plugin_id} ${a.version} fail ${b}`;return log.error(c),d(c)}downloaded[a.plugin_id]||(downloaded[a.plugin_id]={}),downloaded[a.plugin_id][a.version]=!0}).pipe(fs.createWriteStream(c));e.on("finish",async()=>{return b()})})}exports.downloadPlugin=downloadPlugin;async function installPlugin(a){const b=`${a.plugin_id}_${a.version}.wxpkg`,c=path.join(dirConfig.WeappApplication,b),d=path.join(dirConfig.WeappPlugin,a.plugin_id);return new Promise(async(b,f)=>{try{if(!signature_1.checkFileMd5Signature(c,a.checksum))return fs.unlinkSync(c),f(new Error("Incorrect md5"));const e=fs.readFileSync(c),g=await gunzipPack(e),h=unpack(g),i=JSON.parse(h["/manifest.json"]);if(i.version===a.version){for(const a in h){const b=path.join(d,a);mkdir.sync(path.dirname(b)),fs.writeFileSync(b,h[a])}idepluginManager.cleanFileCache(a.plugin_id),store.dispatch(pluginActions.setPluginManifests(Object.assign({},store.getState().plugin.pluginManifests,{[a.plugin_id]:i}))),fs.unlinkSync(c),b()}}catch(b){try{fs.unlinkSync(path.join(d,"./manifest.json"))}catch(a){}const c=`installPlugin ${a.plugin_id} ${a.version} catch error ${b}`;log.error(c),f(c)}})}exports.installPlugin=installPlugin;function clearLoopTimer(){loopTimer&&(clearInterval(loopTimer),loopTimer=null)}async function loop(){clearLoopTimer();try{idepluginManager.recoverPlugins(),doCheckUpdate(),idepluginManager.updateOfflinePlugins(),idepluginManager.removeUselessPlugins()}catch(a){}loopTimer=setInterval(()=>{try{doCheckUpdate()}catch(a){}},CHECK_INTERVAL)}exports.loop=loop;
;}(require("lazyload"), require);
