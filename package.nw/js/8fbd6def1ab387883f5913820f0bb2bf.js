'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){function a(a,b){return Math.floor(Math.random()*(b-a+1))+a}const b=require('path'),c=require('react'),d=require('lodash'),e=require('./a1dd553cc059d528bb0ef56afed53968.js'),f=require('./a15851ca252a104aad8b3fd3fc114574.js'),g=require('./51a8f674caffc4c2fa2358314af90837.js'),h=require('./9a24eb4fb7a49d4dd24531943fc3c899.js'),i=require('./e9e3fd38aeedddd6db73d1d015ff6952.js'),j=require('./2dfc6a3df6d6fc51266b293c8420e88b.js'),k=require('./72653d4b93cdd7443296229431a7aa9a.js'),l=require('./99fff845d6c7bff564f99e38e435f827.js'),m=require('./6fc66cd42da3e8c155b22db441702cda.js'),n=require('./e5bd2ea26ba0b23aa8e370d56d46c324.js'),o=require('./dad33c2ec743db4fb830cd47f17c38f6.js'),p=require('./ea653f45dc25181ca4f1b108175009b7.js'),q=require('classnames'),r=require('./0794878a22a26634e42df858bbaca543.js'),s=require('./ff946754202ecf377034d29daac7c8d9.js'),t=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),u=require('./common/locales/index.js'),v=require('./3bfffbe88b3d923921f851c0697974fe.js'),w=require('./71734cad2a6081d396ea668ffa405627.js'),x=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),y=require('./84b183688a46c9e2626d3e6f83365e13.js'),{resetBackgroundStatus:z}=require('./a3959bb900db9f65ed2e9c5dfa6977b7.js'),A=require('./949d8235c744ced2a80121e4dba34c28.js'),B=require('./efd8b4323f89b2a759d044d894e3a4f0.js'),C=require('./5d0f2b7b8c329790946b9b597749ad67.js'),D='about:blank',E=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),F=require('./87822abadd12d18b00ea00716f2410f6.js'),G=require('./a78e6d6a87de1708226375ca4c320d76.js'),{validType:H,tokenManager:I}=require('./dc244a5ba483ad6e0acd267d3b91b282.js'),{setWebSocketHeader:J}=require('./ffc9a3cdcc5036d1fb62a2324c72a2b0.js'),K=require('./e92285f0dd3fc4dc1f7df18a8a32d39c.js'),L=require('./32de5d16fa0407815a081d7c2ff94d8b.js'),M=require('./6242f55dbdfe53c2f07b7a51568311f2.js'),N=require('./344232cd2199c9c3a024b4005d054672.js'),O=require('./5f3c86137d346ddffec99d08c1ac2bb0.js').default,P=require('./c44dddb4ccd769f104fce4a777049908.js'),Q=require('./56646b0ffe5c7ea492bcc44ea72277a8.js'),R=require('./da7c31daaf542cf1796023d8e344b98a.js'),{buildResizeEvent:S}=require('./a3d662b5798bbb27bf21be3e3587a588.js'),{weappLocalIdRegular:T,weappUsrFilePathPrefix:U,weappTmpFilePathPrefix:V,weappStoreFilePathPrefix:W}=M;class X extends c.Component{constructor(a){super(a),this.checkOnAfterInvokeAndReturn=(a,b,c)=>{const d=t.SIMULATOR_PLUGIN_HOOK_METHODS.APPSERVICE,f=(b)=>{b&&(this.syncDialogMap[a]?(this.syncDialogMap[a].ok(JSON.stringify(b)),delete this.syncDialogMap[a]):e.invokeCallback(a,b))};P.has({command:d.onAfterInvoke,api:c})?this.simulatorPluginMessager.simulatorHookMethodCallback(d.onAfterInvoke,P.get({command:d.onAfterInvoke,api:c}),b||{}).then((a)=>{f(a)}):f(b)},this.onResizeStop=(a,b,c)=>{this.props.windowActions.setDebuggerWindow({height:c})},this.syncDialogMap={},this.restartTimer=null,this.subPackageLoading={},this.mainPackageLoading=!1,this.taskMap=new L,this.session=+new Date,this.bbsConfig=d.cloneDeep(this.props.bbsConfig||[])}componentDidMount(){this._onAppServiceMessage=this.onAppServiceMessage.bind(this),e.register(this._onAppServiceMessage),this._onAppDataMessage=this.onAppDataMessage.bind(this),this.appdataMessager=i.get('appdata_miniprogram'),this.appdataMessager.ready=!1,this.appdataMessager.register(this._onAppDataMessage),this.simulatorType=B.wechat,this.props.project&&(this.simulatorType=this.props.project.simulatorType,this.simulatorType!==B.wechat&&(this.simulatorPluginMessager=i.get(this.simulatorType),e.simulatorPluginMessager=this.simulatorPluginMessager)),this.updateIdepluginMessager=this.updateIdepluginMessager.bind(this),this._onStorageMessage=this.onStorageMessage.bind(this),this.storageMessager=i.get('storage_miniprogram'),this.storageMessager.ready=!1,this.storageMessager.register(this._onStorageMessage),this.traceMessage=i.get('trace_miniprogram'),this._onDevtoolsMessage=this.onDevtoolsMessage.bind(this),h.register(this._onDevtoolsMessage),j.initHelper({setDebuggerWindow:this.props.setDebuggerWindow.bind(this)}),this.setupBBSLogWorkerListener(),this.initWebview()}componentWillUnmount(){this.devtoolsview&&this.devtoolsview.detach(),this.webview&&(this.webview.detach(),global.online&&F.manager.removeWebview('appservice')),e.unRegister(this._onAppServiceMessage),this.appdataMessager.unRegister(this._onAppDataMessage),this.storageMessager.unRegister(this._onStorageMessage),h.unRegister(this._onDevtoolsMessage);try{global.worker.bbsLogWorker&&(global.worker.bbsLogWorker.onmessage=null)}catch(a){k.error(a)}}componentWillReceiveProps(a){if(a.debuggerResume!=this.props.debuggerResume&&h.send({command:'DEBUGGER_RESUME',data:a.debugInfo}),a.debuggerStepOver!=this.props.debuggerStepOver&&h.send({command:'DEBUGGER_STEP_OVER',data:a.debugInfo}),a.assdkCallbackInfo!=this.props.assdkCallbackInfo){const{callbackID:b,res:c,api:d}=a.assdkCallbackInfo;this.checkOnAfterInvokeAndReturn(b,c,d)}const b=_extends({},this.props.device),c=_extends({},a.device);if(delete b.screenWidth,delete b.screenHeight,delete b.navigationbarHeight,delete c.screenWidth,delete c.screenHeight,delete c.navigationbarHeight,(a.compileCommand!=this.props.compileCommand||JSON.stringify(b)!==JSON.stringify(c))&&(e.ready=!1,this.restart()),a.appLaunched!=this.props.appLaunched&&a.appLaunched&&this.taskMap.onTaskDone('appLaunched'),a.appRoute!=this.props.appRoute&&('ready'==a.appRoute.status?'appLaunch'==a.appRoute.openType?setTimeout(()=>{this.triggerLaunch()}):this.triggerAppRoute(a):'done'==a.appRoute.status&&this.triggerAppRouteDone(a)),a.networkType!=this.props.networkType&&e.triggerOnEvent({eventName:'onNetworkStatusChange',data:{isConnected:'none'!==a.networkType,networkType:a.networkType}}),a.storage!=this.props.storage&&this.storageMessager.triggerOnEvent('UPDATE_STORAGE',a.storage),a.subPackageLoaded!=this.props.subPackageLoaded&&setTimeout(()=>{this.checkSubPackages()}),a.debugInfo!=this.props.debugInfo&&a.debugInfo&&h.send({command:'DISPATCH_MESSAGE',data:a.debugInfo}),a.console!=this.props.console&&this.webview){const b=a.console.type;let c;if('clear'==b)c='console.clear()';else if('error'==b){const b=encodeURIComponent(a.console.msg);c=`console.error(decodeURIComponent(\`${b}\`))`}else if('log'==b){const b=encodeURIComponent(a.console.msg);c=`console.log(decodeURIComponent(\`${b}\`))`}else if('warn'==b){const b=encodeURIComponent(a.console.msg);c=`console.warn(decodeURIComponent(\`${b}\`))`}c&&this.webview.executeScript({code:c})}a.networkType!=this.props.networkType&&this.webview&&this.webview.executeScript({code:`
        var event = new CustomEvent("networkChange", {
          detail: {
            networkStatus: '${a.networkType}'
          }
        })
        window.dispatchEvent(event)
        `}),a.theme!==this.props.theme&&this.setDevtoolsTheme(),this.updateIdepluginMessager(a)}updateIdepluginMessager(a){const b=a.project.simulatorType;this.simulatorType!==b&&(this.simulatorType=b,b!==B.wechat&&(this.simulatorPluginMessager=i.get(b),e.simulatorPluginMessager=this.simulatorPluginMessager))}setDevtoolsTheme(){clearTimeout(this.setDevtoolsThemeTimer),this.setDevtoolsThemeTimer=setTimeout(()=>{const a='dark'===this.props.theme?'dark':'default';h.send({command:'SET_THEME',data:a})})}setupBBSLogWorkerListener(){this._bbsLogWorkerListener=(a)=>{if(a.data){if(a.data.error)return void k.error(a.data.error);try{if(a.data.ext.session!==this.session)return;const b=a.data.result.config,c=a.data.ext;j.display({command:t.DISPLAY_INFO,type:t.DISPLAY_TYPES.BBS_LOG_LINK,data:{messageLevel:c.level,message:c.message,explanation:b.explanation,link:b.link,linkType:b.linkType}})}catch(a){k.error(a)}}};try{global.worker.bbsLogWorker.onmessage=this._bbsLogWorkerListener}catch(a){k.error(a)}}triggerAppRouteDone(a){let b=a.currentWebview,c=b.pathName;const d=()=>{let d={};for(let a in b.query)d[a]=encodeURIComponent(b.query[a]);e.triggerOnEvent({eventName:'onAppRouteDone',data:{webviewId:b.id,path:c+'.html',query:d,openType:a.appRoute.openType}})};let f=x.checkIsInSubPackage(a.appConfig,c);f?this.taskMap.checkTaskPromise(f.root,d):this.taskMap.checkTaskPromise(t.MINI_PROGRAM_MAIN_PACKAGE_ROOT,d)}triggerAppRoute(a){let b=a.currentWebview,c=b.pathName;const d=async()=>{let d={};for(let a in b.query)d[a]=encodeURIComponent(b.query[a]);const g=a.rotatedBeforeRoute&&!a.rotated,h=g?{resizing:!0}:{},i=b.id,j=b.pageOrientation;if(e.triggerOnEvent({eventName:'onAppRoute',webviewID:i,data:_extends({webviewId:i,path:c+'.html',query:d,openType:a.appRoute.openType},h)}),g){const b=a.rotated?'landscape':'portrait',c=await S({eventName:'onAppRouteResized',deviceOrientation:b})(E.getState);e.triggerOnEvent(c),f.triggerOnEvent(c)}};let g=x.checkIsInSubPackage(a.appConfig,c);g?this.taskMap.checkTaskPromise(g.root,d):this.taskMap.checkTaskPromise(t.MINI_PROGRAM_MAIN_PACKAGE_ROOT,d)}triggerLaunch(){let b=this.props.currentWebview,c=b.pathName;const d=this.props.simulateUpdate,f=()=>{e.triggerOnEvent({eventName:'onAppRoute',data:{webviewId:b.id,path:c+'.html',query:b.query,scene:this.props.scene,openType:'appLaunch'}}),d?(this.props.simulatorActions.setSimulateUpdate(!1),setTimeout(()=>{e.triggerOnEvent({eventName:'onUpdateStatusChange',data:{state:'updating'}}),setTimeout(()=>{e.triggerOnEvent({eventName:'onUpdateStatusChange',data:{state:'updateReady'}})},a(1e3,5e3))},a(1e3,5e3))):setTimeout(()=>{e.triggerOnEvent({eventName:'onUpdateStatusChange',data:{state:'noUpdate'}})},a(1e3,5e3))};let g=x.checkIsInSubPackage(this.props.appConfig,c);g?this.taskMap.checkTaskPromise(g.root,f):this.taskMap.checkTaskPromise(t.MINI_PROGRAM_MAIN_PACKAGE_ROOT,f)}initWebview(){let a=G.get('devtools',{}),b=G.get('appservice',{id:'appservice'});this.devtoolsview&&this.devtoolsview.detach(),this.webview&&(this.webview.detach(),global.online&&F.manager.removeWebview('appservice')),this.devtoolsview=a,this.webview=b;const c=I.getSessionToken(H.UA_TOKEN);b.setUserAgentOverride(`wechatdevtools appservice port/${global.messageCenterPort} token/${c} ${this.props.popup?'popup':''}`),b.setAttribute('tabIndex','-1'),b.on('exit',(a)=>{('abnormal'===a.reason||'crash'===a.reason||'killed'===a.reason)&&this.initWebview()}),b.on('consolemessage',(a)=>{if((!a.sourceId||a.sourceId.match(/http:\/\/127\.0\.0\.1:\d+\/appservice\/__dev__\//))&&!(1>a.level)){const b=a.message;if(b)try{this.bbsConfig&&global.worker.bbsLogWorker.postMessage({msgType:'evaluate',msgData:{message:a.message,context:{libVersion:this.props.project&&this.props.project.libVersion},ext:{session:this.session,level:a.level,message:a.message}}})}catch(a){k.error(a)}}}),this.initWebviewEvent(b);let d=`${a.originUserAgent} appservicedevtools port/${global.messageCenterPort} proxy/${global.proxyPort} token/${c} ${this.props.popup?'popup':''} ${global.isSimple?'simple':''}`;a.setUserAgentOverride(d),a.setAttribute('style','height:100%;width:100%;position:relative;display:block;'),a.on('exit',(a)=>{('abnormal'===a.reason||'crash'===a.reason||'killed'===a.reason)&&this.initWebview()}),a.on('dialog',(a)=>{a.preventDefault();const b=a.messageType,c=a.messageText,d=a.dialog;if('alert'===b){if(d&&d.ok(),0<=c.indexOf('debugger:paused'))this.props.simulatorActions.setDebugger({paused:!0});else if(0<=c.indexOf('debugger:resumed'))this.props.simulatorActions.setDebugger({paused:!1});else if('FMP'===c)N.markDevtoolsPaint();else if(0<=c.indexOf('debugger:click')){const a=c.split(':')[2];'wxml'===a?R('open_panel_wxml',!0):'appdata'===a?R('open_panel_appdata',!0):'storage'===a?R('open_panel_storage',!0):'trace'===a?R('open_panel_trace',!0):'audits'===a?R('open_panel_audits',!0):void 0}}else if('prompt'===b){if(c===t.GET_MESSAGE_TOKEN)return void d.ok(s.getToken(['APPSERVICEDEVTOOLS','PLUGIN']));if('GET_THEME'===c)return void d.ok('dark'===this.props.theme?'dark':'default');a.dialog.ok('')}}),b.attach(this.appservicecontainer),this.showDevTools(),global.online&&F.manager.addWebview('appservice',b._webview,{isAppservice:!0})}initWebviewEvent(a){a.on('dialog',(a)=>{let b=a.messageType||'',c=a.messageText;if('prompt'===b){if(a.preventDefault(),/^____sdk____/.test(c)){const b=t.SIMULATOR_PLUGIN_HOOK_METHODS.APPSERVICE;let e=JSON.parse(c.replace(/^____sdk____/,'')),f=e.command;if('APPSERVICE_INVOKE'===f){const{api:c,callbackID:f}=e.data;this.syncDialogMap[f]=a.dialog,P.has({command:b.onBeforeInvoke,api:c})?this.simulatorPluginMessager.simulatorHookMethodCallback(b.onBeforeInvoke,P.get({command:b.onBeforeInvoke,api:c}),e.data.args).then((a)=>{if(a.preventDefault)return void this.checkOnAfterInvokeAndReturn(f,a.result||{},c);const b=a.args,g=d.cloneDeep(e);g.data.args=b,this.props.assdkActions.exec(g.data).then((a)=>{a&&this.checkOnAfterInvokeAndReturn(f,a,c)})}):this.props.assdkActions.exec(e.data).then((a)=>{a&&this.checkOnAfterInvokeAndReturn(f,a,c)})}}else c===t.GET_MESSAGE_TOKEN?a.dialog.ok(s.getToken('APPSERVICE')):a.dialog.ok('');}else if('alert'==b)if('DOCUMENT_READY'==c)e.ready=!0,this.props.simulatorActions.setAppLaunched(!0),N.markFirstCompileComplete();else if(0==c.indexOf('SUBPACKAGE_READY_')){let a=c.replace(/^SUBPACKAGE_READY_/,'');this.props.subPackageLoaded[a]&&this.props.subPackageLoaded[a].taskId&&e.triggerOnEvent({eventName:'onLoadSubPackageTaskStateChange',data:{moduleName:a,state:'success',taskId:this.props.subPackageLoaded[a].taskId}}),this.props.simulatorActions.setSubPackage(a,!0)}else if(0===c.indexOf('SET_SOCKET_HEADER:'))try{let a=JSON.parse(c.replace('SET_SOCKET_HEADER:',''));J(a)}catch(a){}}),a.onBeforeRequest=(a)=>{if(!/^https?:\/\//i.test(a.url))return{cancel:!0}},a.onRequestErrorOccurred=(a)=>{let{type:b}=a;if('main_frame'===b&&0===a.error.indexOf('net::')&&'net::ERR_BLOCKED_BY_CLIENT'!==a.error)return void j.display({command:t.DISPLAY_ERROR,data:{code:A.APPSERVICE_NETWORK_ERROR,error:{details:a}}})},a.onRequestBeforeSendHeaders=(a)=>{let b=this.props.project;if(b){let b=a.url;if('main_frame'===a.type&&b.match(/\?load$/))return this.restart(),{cancel:!0};if(0!=b.indexOf(`http://127.0.0.1:${global.proxyPort}/appservice`)&&0!=b.indexOf(`http://127.0.0.1:${global.proxyPort}/calibration/`)&&!/favicon\.ico$/.test(b)&&'none'==this.props.networkType)return j.display({command:t.DISPLAY_ERROR,data:{title:u.config.NO_NETWORK_TIPS_TITLE,error:{message:u.config.NO_NETWORK_TIPS_CONTENT.format(b)}}}),{cancel:!0};let d=a.requestHeaders||[],e=d.findIndex((a)=>{return'cookie'===a.name.toLowerCase()});d.splice(e,1);for(var c=0;c<d.length;++c){if('_Cookie'===d[c].name&&(d[c].name='Cookie'),'Referer'===d[c].name){let a=v.getProjectAppID();d[c].value=`https://servicewechat.com/${a}/devtools/page-frame.html`}if('User-Agent'===d[c].name){const a=I.getSessionToken(H.UA_TOKEN);d[c].value=this.props.ua.replace('{{webviewID}}','')+' token/'+a}}return{requestHeaders:a.requestHeaders}}},a.onRequestHeadersReceived=(a)=>{let{type:b}=a;if('xmlhttprequest'===b){let b=a.responseHeaders||[],c={};return b.forEach((a)=>{let{name:b,value:d}=a;c[b]||(c[b]=[]),c[b].push(d)}),b.push({name:'for-weapp-devtools',value:JSON.stringify(c)}),{responseHeaders:b}}return{}}}_newwindow(a){a.preventDefault();let b=a.targetUrl;if(b)return 0===b.indexOf(`http://127.0.0.1:${global.proxyPort}/appservice/appservice`)||`http://127.0.0.1:${global.proxyPort}/favicon.ico`===b?void 0:0!==b.indexOf('ws://')&&0!==b.indexOf('wss://')?T.test(b)||0===b.indexOf('http://'+V+'/')||0===b.indexOf('http://'+W+'/')||0===b.indexOf('http://'+U+'/')||0===b.indexOf('/'+V+'/')||0===b.indexOf('/'+W+'/')||0===b.indexOf('/'+U+'/')||0===b.indexOf('chrome://inspect')?void nw.Window.open(b,{width:799,height:799},function(){}):0===b.indexOf('https://developers.weixin.qq.com')?0===b.indexOf('https://developers.weixin.qq.com/minigame')||0===b.indexOf('https://developers.weixin.qq.com/miniprogram')?void nw.Shell.openExternal(b):void this.props.BBS(b,t.IDE_SCENE.DEBUGGER):('https://developers.google.com/web/tools/chrome-devtools/'===b&&(b='https://developers.weixin.qq.com/miniprogram/dev/index.html'),'https://developers.google.com/web/updates/2017/05/devtools-release-notes'===b&&(b='https://developers.weixin.qq.com/miniprogram/dev/devtools/uplog.html'),'devtools://audits'===b?void h.send({command:'SHOW_PANNEL',data:{name:'Audits'}}):void nw.Shell.openExternal(b)):void 0}hackNewWindow(a){a.on('newwindow',this._newwindow.bind(this))}startAudits(){if(this.audits&&this.audits.getWrappedInstance)try{this.audits.getWrappedInstance().loadPanel({startAudits:!0})}catch(a){}}showDevTools(){let a=this.devtoolsview,b=this.webview;a.attach(this.container),this.hackNewWindow(a);const c=()=>{a.off('loadstop',c);const d=()=>{b.off('loadstop',d),b.showDevTools(!0,a._webview),this.loaded=!0,this.onWebviewLoadCommit(),O.registerFirstCompileListener(),this.props.project&&this.props.project.setting&&this.props.project.setting.autoAudits?this.startAudits():this.props.simulatorActions.compile()};b.on('loadstop',d),this.resetStatus(),b.src=D};a.on('loadstop',c),a.src=D}resetStatus(){this.loaded=!1,this.taskMap.clear(),this.subPackageLoading={},this.mainPackageLoading=!1,this.syncDialogMap={},this.bbsConfig=d.cloneDeep(this.props.bbsConfig||[]),z()}restart(){this.session=+new Date,clearTimeout(this.restartTimer),this.restartTimer=setTimeout(()=>{if(!this.loaded||!this.webview||!this.props.appConfig)return;h.send({command:'DISABLE_DEBUG_AGENT',data:{}}),j.cleanQueue(),this.props.simulatorActions.launch();let a=()=>{h.send({command:'ENABLE_DEBUG_AGENT',data:{}}),this.webview.off('loadcommit',a),this.loaded=!0,e.ready=!0,clearTimeout(this.restartLoadCommitTimer)},b=`http://127.0.0.1:${global.proxyPort}/appservice/appservice?t=${Date.now()}`;this.resetStatus(),this.webview.on('loadcommit',a),this.webview.src=b,this.taskMap.checkTaskPromise('appLaunched',this.checkPluginInfo.bind(this)),this.bbsConfig=d.cloneDeep(this.props.bbsConfig||[]);try{global.worker.bbsLogWorker.postMessage({msgType:'updateConfig',msgData:this.bbsConfig})}catch(a){}this.restartLoadCommitTimer=setTimeout(()=>{this.props.infoActions.showError(u.config.MINI_PROGRAM_CONSUME_TIMING),this.initWebview()},6e4)})}onWebviewLoadCommit(){j.initWebview(this.webview)}onDevtoolsMessage(a){if('CLICK'===a.command){if(this.devtoolsview){const a=new UIEvent('click',{bubbles:!0});this.devtoolsview._webview.dispatchEvent(a)}}else if('RESET_NETWORK_CACHE'==a.command)C.clean();else if('Network.getResponseBody'==a.command){var b=C.get(a.data.params.requestId);h.send({command:'DISPATCH_MESSAGE',data:{id:a.data.id,result:{body:b.toString('base64'),base64Encoded:!0}}})}else'Button.popup'===a.command?this.props.windowActions.setDebuggerWindow({popup:!this.props.popup}):'THEME_MODIFIED'===a.command&&this.onDevtoolsThemeModified()}onDevtoolsThemeModified(){const a=()=>{this.devtoolsview.off('loadstop',a),this.restart()};this.devtoolsview.on('loadstop',a),this.devtoolsview.reload()}onAppServiceMessage(a){let{command:b,data:c}=a;if('APPSERVICE_PUBLISH'==b)e.publish(a);else if('APPSERVICE_INVOKE'==b){const a=t.SIMULATOR_PLUGIN_HOOK_METHODS.APPSERVICE;if('traceEvent'===c.api)return void this.traceMessage.triggerOnEvent('TRACE_EVENT',{args:c.args});setTimeout(()=>{P.has({command:a.onBeforeInvoke,api:c.api})?this.simulatorPluginMessager.simulatorHookMethodCallback(a.onBeforeInvoke,P.get({command:a.onBeforeInvoke,api:c.api}),c.args).then((a)=>{if(a.preventDefault)return void this.checkOnAfterInvokeAndReturn(c.callbackID,a.result||{},c.api);const b=a.args||void 0,e=d.cloneDeep(c);b&&(e.args=b),this.props.assdkActions.exec(e).then((a)=>{a&&this.checkOnAfterInvokeAndReturn(c.callbackID,a,c.api)})}):this.props.assdkActions.exec(c).then((a)=>{a&&this.checkOnAfterInvokeAndReturn(c.callbackID,a,c.api)})})}else'SEND_APP_DATA'==b?this.appdataMessager.ready&&this.appdataMessager.triggerOnEvent('SEND_APP_DATA',c):'SYSTEM'==b&&this.onSystemCommand(c.api,c.data)}async loadMainPackage(){return new Promise((a,b)=>{return this.subPackageLoading[t.MINI_PROGRAM_MAIN_PACKAGE_ROOT]?void this.taskMap.checkTaskPromise(t.MINI_PROGRAM_MAIN_PACKAGE_ROOT,a):void(this.subPackageLoading[t.MINI_PROGRAM_MAIN_PACKAGE_ROOT]=!0,K(this.props.project).then((b)=>{this.webview.executeScript({code:b},()=>{a()})}).catch((a)=>{b(a)}))})}checkSubPackages(){for(let a in this.props.subPackageLoaded){if(this.props.subPackageLoaded[a].loaded){this.taskMap.onTaskDone(a);continue}this.taskMap.checkTaskPromise('appLaunched',async()=>{if(a===t.MINI_PROGRAM_MAIN_PACKAGE_ROOT)return void(await this.loadMainPackage());let b=x.checkIsIndependentSubpackage(this.props.appConfig,a);if(b||this.props.subPackageLoaded[t.MINI_PROGRAM_MAIN_PACKAGE_ROOT]&&this.props.subPackageLoaded[t.MINI_PROGRAM_MAIN_PACKAGE_ROOT].loaded||(await this.loadMainPackage()),!this.subPackageLoading[a]){this.subPackageLoading[a]=!0;let b=await w(this.props.project,a);this.webview.executeScript({code:b},()=>{})}})}}checkPluginInfo(){try{const a=this.props.project;if(a&&a.pluginInfo&&a.pluginInfo.length)for(const b of a.pluginInfo)if(b.current&&(b.latest&&'dev'!==b.current.version&&b.current.version!==b.latest.version&&j.display({command:t.DISPLAY_INFO,type:t.DISPLAY_TYPES.PLUGIN_UPDATE_INFO,data:{name:b.name,currentVersion:b.current.version,latestVersion:b.latest.version}}),b.onlineVersion&&b.onlineVersion!==b.current.version&&0>y.compareSemVer(b.current.version,b.onlineVersion))){j.display({command:t.DISPLAY_ERROR,type:'none',data:{title:u.config.PROJECT_PLUGIN_VERSION_WARNING,msg:u.config.PROJECT_PLUGIN_VERSION_UNMATCHED_WITH_VERSION_USED_IN_ONLINE_MINI_PROGRAM.format([b.name,b.current.version,b.onlineVersion])}});continue}}catch(a){k.error(`appservice.js checkPluginInfo fail with error: ${a.toString()}`)}}onSystemCommand(a,b){Q[a]&&Q[a](b)}onAppDataMessage(a){let{command:b,data:c}=a;'GET_APP_DATA'==b?(this.appdataMessager.ready=!0,e.send({command:'GET_APP_DATA'})):'WRITE_APP_DATA'==b?e.send({command:'WRITE_APP_DATA',data:c}):'ON_PANEL_HIDE'==b&&(this.appdataMessager.ready=!1)}onStorageMessage(a){let{command:b,data:c}=a;'EXEC_STORAGE_SDK'==b?this.props.assdkActions.exec(c):'STORAGE_PANNEL_SHOW'==b?(this.storageMessager.ready=!0,this.props.assdkActions.exec({api:'getStorage',args:{},callbackID:-1})):'STORAGE_PANNEL_HIDE'==b&&(this.storageMessager.ready=!1)}render(){let a=this.props,b={height:a.height};a.show&&!a.editorShow&&(b.flex='1');let d=q('devtools',{"ui-invisible":!a.show});return a.windowStatus.mini?c.createElement('div',{ref:(a)=>this.container=a,style:{width:'100%',height:'100%'}},c.createElement(l,null),c.createElement(m,null),c.createElement(n,{ref:(a)=>this.audits=a}),c.createElement(o,null),c.createElement('div',{className:'ui-divider ui-divider-horizontal',style:{pointerEvents:'none'}}),c.createElement('div',{ref:(a)=>this.appservicecontainer=a,style:{width:0,height:0},tabIndex:-1})):a.popup?(b.width='100%',b.height='100%',c.createElement('div',{ref:(a)=>this.container=a,className:d,style:b},c.createElement(l,null),c.createElement(m,null),c.createElement(n,{ref:(a)=>this.audits=a}),c.createElement(o,null),c.createElement('div',{className:'ui-divider ui-divider-horizontal',style:{pointerEvents:'none'}}),c.createElement('div',{ref:(a)=>this.appservicecontainer=a,style:{width:0,height:0},tabIndex:-1}))):c.createElement(p,{innerRef:(a)=>this.container=a,width:'100%',height:a.popup?'100%':a.height,className:d,style:b,topResizable:!0,onResizeStop:this.onResizeStop},c.createElement(l,null),c.createElement(m,null),c.createElement(n,{ref:(a)=>this.audits=a}),c.createElement(o,null),c.createElement('div',{className:'ui-divider ui-divider-horizontal',style:{pointerEvents:'none'}}),c.createElement('div',{ref:(a)=>this.appservicecontainer=a,style:{width:0,height:0},tabIndex:-1}))}}module.exports=X}(require('lazyload'),require);