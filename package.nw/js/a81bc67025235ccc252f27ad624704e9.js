'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){function a(){const a=i.getCurrent(),b=a.appid===m.TOURIST_APPID,c=a.setting.urlCheck;let d=!0;return b?d=!1:!c&&(d=!1),d}var b=Math.floor;const c=require('fs'),d=require('path'),e=directRequire('os'),f=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),g=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),h=require('./233d77ecf0781f44985f684f70e316d0.js'),i=require('./3bfffbe88b3d923921f851c0697974fe.js'),j=require('./f6cbcecf6ed9f533f6a506310d8f07b6.js'),k=require('./dfd9a72b9ff6078018aa4a64eed949a5.js'),l=require('./2dfc6a3df6d6fc51266b293c8420e88b.js'),m=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),n=require('./5d0f2b7b8c329790946b9b597749ad67.js'),o=require('./common/locales/index.js'),p=m.CONTENTTYPEINFO,q=/^(http|ws)s?:\/\/[\w-.]+(:\d+)?/i;let r=0,s=0,t={},u=1,v={},w=1;const x=(a='')=>{return a},y=(a)=>{const b=[];for(const c in a)if('set-cookie'===c.toLowerCase()){const d=a[c],e=Object.prototype.toString.call(d);if('[object String]'===e){b.push(x(d.trim()));continue}if('[object Array]'===e){for(const a of d)b.push(x(a.trim()));continue}}return b},z=(a,b)=>{const c={};for(const d in a){const e=Object.prototype.toString.call(a[d]);c[d]='[object Array]'===e?a[d].join(b):a[d]}return c},A=()=>{const a=e.networkInterfaces();for(const b in a)for(const c of a[b])if('IPv4'===c.family&&!1===c.internal)return[c.address,c.netmask]};module.exports={downloadFile:async function(b,f,e){const g=f.args;if(j.isLocalId(g.url)){const a=j.getFileRealPath(g.url);return a&&c.existsSync(a.fileRealPath)?{errMsg:`${f.api}:ok`,statusCode:200,tempFilePath:g.url}:{errMsg:`${f.api}:ok`,statusCode:404}}const k=e(),n=k.toolbar.network.list[k.toolbar.network.current];if('none'==n)return{errMsg:`${f.api}:fail network is down`};const r=i.getCurrent(),t=i.getCurrentRuntimeConfig();let u=i.isGameApp(r)?1024*(1024*t.setting.GameDownloadFileSizeLimit):1024*(1024*t.setting.DownloadFileSizeLimit);const v=k.simulator.appConfig||{},w=t.setting.MaxDownloadConcurrent;return s>=w?{errMsg:`${f.api}:fail exceed max download connection count ${w}`}:new Promise((b)=>{let e=!1;const n=(a)=>{e||(s--,b(a),e=!0)};try{s++;let b=0,e=200,t=d.extname(g.url.split('?')[0]);const w=j.createTmpfileName(r,t),x=j.getFileRealPath(w),y=x.fileRealPath,z=g.header&&'object'==typeof g.header?g.header:{};z.Referer=`https://servicewechat.com/${i.getProjectAppID()}/devtools/page-frame.html`;const A=k.toolbar&&k.toolbar.deviceInfo&&k.toolbar.deviceInfo.ua||'';z['User-Agent']=A.replace('{{webviewID}}','');let B=!1;const C={method:'get',url:g.url,encoding:null,headers:z,timeout:g.timeout||v.networkTimeout&&v.networkTimeout.downloadFile||6e4,followRedirect(b){if(!a())return!0;const c=b.statusCode;if(300<=c&&400>c&&(302==c||301==c)){const a=b.caseless.get('location'),c=i.getCurrentRuntimeDomains().download;let d=q.exec(a.toLowerCase());d=d&&d[0]||'';for(let a=0;a<c.length;a++){const b=c[a];let e=q.exec(b.toLowerCase());if(e=e&&e[0],e==d)return!0}const e=[];c.forEach((a)=>{e.push([a])}),l.display({command:m.DISPLAY_INFO,type:m.DISPLAY_TYPES.DOMAIN_ERROR,data:{type:'download',url:`302: ${a}`,domains:e}}),B=!0}return!1}};a()?C.agentOptions={secureProtocol:'TLSv1_2_method'}:C.tunnel=!1;const D=h(C),E=[];D.on('response',(a)=>{if(e=a.statusCode,200!=e&&206!=e)B?n({errMsg:`${f.api}:fail url not in domain list`}):n({errMsg:`${f.api}:ok`,statusCode:e});else{const b=parseInt(a.headers['content-length']);if(a.headers['content-type']){const b=a.headers['content-type'].replace(/;.*/g,''),c=p[b.toLowerCase()];if(c)t=`.${c}`;else{const a=b.split('/');a&&a[1]&&!/\-|\+/ig.test(a[1])&&(t=`.${a[1]}`)}}b>u&&(D.abort(),n({errMsg:`${f.api}:fail exceed max file size`}))}}).on('error',function(a){a&&'EPROTO'===a.code?n({errMsg:`${f.api}:fail ${o.config.TLS_VERSION_REQUIRED}`}):a&&('ETIMEDOUT'===a.code||'ESOCKETTIMEDOUT'===a.code)?n({errMsg:`${f.api}:fail timeout`}):n({errMsg:`${f.api}:fail ${a}`})}).on('data',(a)=>{b+=a.length,E.push(a),b>u&&(D.abort(),n({errMsg:`${f.api}:fail exceed max file size`}))}).on('end',()=>{const a=Buffer.concat(E),b=j.initTmpfileName(r,a,t),d=j.getFileRealPath(b),g=d.fileRealPath;c.writeFileSync(g,a),c.unlinkSync(y),n({errMsg:`${f.api}:ok`,tempFilePath:b,statusCode:e})}).pipe(c.createWriteStream(y))}catch(a){n({errMsg:`${f.api}:fail ${a}`})}})},uploadFile:async function(b,d,e){const f=d.args,g=i.getCurrentRuntimeConfig(),k=g.setting.MaxUploadConcurrent,l=e(),m=l.toolbar.network.list[l.toolbar.network.current];if('none'==m)return{errMsg:`${d.api}:fail network is down`};if(r>=k)return{errMsg:`${d.api}:fail exceed max upload connection count ${k}`};const n=f.filePath,p=j.getFileRealPath(n),q=p.fileRealPath;if(!c.existsSync(q))return{errMsg:`${d.api}:fail file not found`};const s=l.simulator.appConfig||{};return new Promise((b)=>{let e=!1;const g=(a)=>{e||(r--,e=!0,b(a))};try{r++;const b={url:f.url,headers:f.header||{},formData:f.formData||{},method:'post',timeout:f.timeout||s.networkTimeout&&s.networkTimeout.uploadFile||6e4};a()?b.agentOptions={secureProtocol:'TLSv1_2_method'}:b.tunnel=!1,b.formData[f.name]=c.createReadStream(q),b.headers.Referer=`https://servicewechat.com/${i.getProjectAppID()}/devtools/page-frame.html`;const e=l.toolbar&&l.toolbar.deviceInfo&&l.toolbar.deviceInfo.ua||'';b.headers['User-Agent']=e.replace('{{webviewID}}','');h(b,(a,b,c)=>{let e={};e=a?b&&b.statusCode?{errMsg:`${d.api}:ok`,statusCode:b.statusCode,data:c}:'EPROTO'===a.code?{errMsg:`${d.api}:fail ${o.config.TLS_VERSION_REQUIRED}`}:'ETIMEDOUT'===a.code||'ESOCKETTIMEDOUT'===a.code?{errMsg:`${d.api}:fail timeout`}:{errMsg:`${d.api}:fail ${a}`}:{errMsg:`${d.api}:ok`,statusCode:b.statusCode,data:c},g(e)})}catch(a){g({errMsg:`${d.api}:fail ${a}`})}})},createUploadTask:async function(d,f,e){const l=e(),m=f.args,p=i.getCurrentRuntimeConfig(),q=k(),s=p.setting.MaxUploadConcurrent,v=l.toolbar.network.list[l.toolbar.network.current];if('none'==v)return{errMsg:`${f.api}:fail network is down`};if(r>=s)return{errMsg:`${f.api}:fail exceed max upload connection count ${s}`};const w=m.filePath;let x=j.getFileRealPath(w);const A=x.fileRealPath;if(!c.existsSync(A))return{errMsg:`${f.api}:fail file not found`};const B=l.simulator.appConfig||{};let C=m.url;try{C=new URL(m.url).href}catch(a){}try{r++;const e={url:C,headers:m.header||{},formData:m.formData||{},method:'post',timeout:m.timeout||B.networkTimeout&&B.networkTimeout.uploadFile||6e4,time:!0};e.headers.Referer=`https://servicewechat.com/${i.getProjectAppID()}/devtools/page-frame.html`;const j=l.toolbar&&l.toolbar.deviceInfo&&l.toolbar.deviceInfo.ua||'';e.headers['User-Agent']=j.replace('{{webviewID}}',''),a()&&(e.agentOptions={secureProtocol:'TLSv1_2_method'});const k=c.createReadStream(A);e.formData[m.name]=k;const p=u++,s=c.statSync(A);let v=0;const w=Date.now(),D=`1.${p}`;d({type:g.SIMULATOR_DEBUG_INFO,data:{method:'Network.requestWillBeSent',params:{requestId:D,documentURL:e.headers.Referer,request:{url:e.url,method:e.method,headers:e.headers},timestamp:w/1e3,type:'XHR'}}});Date.now()-w;k.on('data',function(a){v+=a.length,q.triggerOnEvent({eventName:'onUploadTaskStateChange',data:{uploadTaskId:p,state:'progressUpdate',progress:b(100*(v/s.size)),totalBytesSent:v,totalBytesExpectedToSend:s.size}})});const E=(a)=>{t[p]&&('success'===a.state&&(a.header=z(J||{},','),a.cookies=y(J||{})),q.triggerOnEvent({eventName:'onUploadTaskStateChange',data:_extends({uploadTaskId:p},a)}),r--,delete t[p])},F=h(e);let G=0;const H=[];let I=200,J={};return F.on('response',(a)=>{I=a.statusCode,J={};for(let b=0,c=a.rawHeaders.length;b<c;b+=2)J[a.rawHeaders[b]]||(J[a.rawHeaders[b]]=[]),J[a.rawHeaders[b]].push(a.rawHeaders[b+1]||'');const b=a.request.timings;d({type:g.SIMULATOR_DEBUG_INFO,data:{method:'Network.responseReceived',params:{requestId:D,timestamp:Date.now()/1e3,type:'XHR',response:{url:e.url,status:a.statusCode,statusText:a.statusMessage,headers:z(J,'\n'),connectionId:D,timing:{requestTime:w/1e3,proxyStart:0,proxyEnd:b.socket,dnsStart:b.socket,dnsEnd:b.lookup,connectStart:b.lookup,connectEnd:b.connect,sslStart:-1,sslEnd:-1,workerStart:-1,workerReady:-1,sendStart:b.connect,sendEnd:b.connect,pushStart:0,pushEnd:0,receiveHeadersEnd:b.response},protocol:a.request.uri.protocol.replace(/:$/,'')+'/'+a.httpVersion}}}}),q.triggerOnEvent({eventName:'onUploadTaskStateChange',data:{uploadTaskId:p,state:'headersReceived',header:z(J,','),cookies:y(J)}})}).on('error',(a)=>{x='EPROTO'===a.code?{state:'fail',errMsg:o.config.TLS_VERSION_REQUIRED}:'ETIMEDOUT'===a.code||'ESOCKETTIMEDOUT'===a.code?{state:'fail',errMsg:'timeout'}:{state:'fail',errMsg:`${a}`},E(x),d({type:g.SIMULATOR_DEBUG_INFO,data:{method:'Network.loadingFailed',params:{requestId:D,timestamp:Date.now()/1e3,type:'XHR',errorText:a.toString(),canceled:!1}}})}).on('data',(a)=>{G+=a.length,H.push(a),d({type:g.SIMULATOR_DEBUG_INFO,data:{method:'Network.dataReceived',params:{requestId:D,timestamp:Date.now()/1e3,dataLength:a.length,encodedDataLength:a.length}}})}).on('abort',()=>{setTimeout(()=>{E({state:'fail',errMsg:'abort'})},0),d({type:g.SIMULATOR_DEBUG_INFO,data:{method:'Network.loadingFailed',params:{requestId:D,timestamp:Date.now()/1e3,type:'XHR',errorText:'abort',canceled:!0}}})}).on('end',()=>{const a=Buffer.concat(H);E({state:'success',statusCode:I,data:a.toString()}),d({type:g.SIMULATOR_DEBUG_INFO,data:{method:'Network.loadingFinished',params:{requestId:D,timestamp:Date.now()/1e3,dataLength:a.length,encodedDataLength:a.length}}}),n.set(D,a,'raw')}),t[p]={id:p,request:F},{errMsg:`${f.api}:ok`,uploadTaskId:p}}catch(a){return r--,{errMsg:`${f.api}:fail ${a}'`}}},operateUploadTask:async function(a,b){const c=b.args,d=c.uploadTaskId,e=c.operationType,f=t[d];return f?'abort'==e?(f.request&&f.request.abort(),{errMsg:`${b.api}:ok`}):{errMsg:`${b.api}:fail illegal operationType`}:{errMsg:`${b.api}:fail task not found`}},createDownloadTask:async function(e,f,r){const t=f.args,u=r(),x=u.toolbar.network.list[u.toolbar.network.current],A=k(),B=i.getCurrent();if('none'==x)return{errMsg:`${f.api}:fail network is down`};if(t.url&&!/^https?:\/\//.test(t.url.toLowerCase()))return{errMsg:`${f.api}:fail invalid url`};const C=i.getCurrentRuntimeConfig(),D=C.setting.MaxDownloadConcurrent;if(s>=D)return{errMsg:`${f.api}:fail exceed max download connection count ${D}`};let E=i.isGameApp()?1024*(1024*C.setting.GameDownloadFileSizeLimit):1024*(1024*C.setting.DownloadFileSizeLimit);const F=t.header&&'object'==typeof t.header?t.header:{};F.Referer=`https://servicewechat.com/${i.getProjectAppID()}/devtools/page-frame.html`;const G=u.toolbar&&u.toolbar.deviceInfo&&u.toolbar.deviceInfo.ua||'';F['User-Agent']=G.replace('{{webviewID}}','');try{s++;let k=0;const r=[];let x=200,C=d.extname(t.url.split('?')[0]);const D=j.createTmpfileName(B,C),G=j.getFileRealPath(D),H=G.fileRealPath,I=u.simulator.appConfig||{};let J=!1,K=t.url;try{K=new URL(t.url).href}catch(a){}const L={method:'get',url:K,encoding:null,headers:F,timeout:t.timeout||I.networkTimeout&&I.networkTimeout.downloadFile||6e4,time:!0,followRedirect(b){if(!a())return!0;const c=b.statusCode;if(300<=c&&400>c&&(302==c||301==c)){const a=i.getCurrentRuntimeDomains().download,c=b.caseless.get('location');let d=q.exec(c.toLowerCase());d=d&&d[0]||'';for(let b=0;b<a.length;b++){const c=a[b];let e=q.exec(c.toLowerCase());if(e=e&&e[0],e==d)return!0}const e=[];a.forEach((a)=>{e.push([a])}),l.display({command:m.DISPLAY_INFO,type:m.DISPLAY_TYPES.DOMAIN_ERROR,data:{type:'download',url:`302: ${c}`,domains:e}}),J=!0}return!1}};a()?L.agentOptions={secureProtocol:'TLSv1_2_method'}:L.tunnel=!1;const M=w++,N=`2.${M}`,O=Date.now();let P={};e({type:g.ASSDK_CALLBACK,res:{errMsg:`${f.api}:ok`,downloadTaskId:M},callbackID:f.callbackID,api:f.api}),e({type:g.SIMULATOR_DEBUG_INFO,data:{method:'Network.requestWillBeSent',params:{requestId:N,documentURL:F.Referer,request:{url:L.url,method:L.method,headers:F},timestamp:O/1e3,type:'XHR'}}});const Q=h(L);v[M]={downloadTaskId:M,request:Q};let R=E;const S=(a)=>{v[M]&&(delete v[M],s--,'success'===a.state&&(a.header=z(P||{},','),a.cookies=y(P||{})),A.triggerOnEvent({eventName:'onDownloadTaskStateChange',data:_extends({downloadTaskId:M},a)}))},T=(a,c)=>{A.triggerOnEvent({eventName:'onDownloadTaskStateChange',data:{downloadTaskId:M,state:'progressUpdate',totalBytesWritten:a,totalBytesExpectedToWrite:c,progress:b(100*(a/c))}})};if(j.isLocalId(t.url)){const a=j.getFileRealPath(t.url);if(!(a&&c.existsSync(a.fileRealPath)))S({state:'success',statusCode:404});else if(t.filePath){const a=j.copyFile(B,t.url,t.filePath);a.error?S({state:'fail',statusCode:403,errMsg:`permission denied, open "${t.filePath}"`}):S({state:'success',filePath:t.filePath,statusCode:200})}else S({state:'success',tempFilePath:t.url,statusCode:200});return}Q.on('response',(a)=>{if(x=a.statusCode,200!=x&&206!=x&&404!=x)J?S({state:'fail',errMsg:'url not in domain list'}):S({state:'success',statusCode:x});else{const b=parseInt(a.headers['content-length']);if(b>E?(Q.abort(),S({state:'fail',errMsg:'exceed max file size'})):R=b,a.headers['content-type']){const b=a.headers['content-type'].replace(/;.*/g,''),c=p[b.toLowerCase()];if(c)C=`.${c}`;else{const a=b.split('/');a&&a[1]&&!/\-|\+/ig.test(a[1])&&(C=`.${a[1]}`)}}}P={};for(let b=0,c=a.rawHeaders.length;b<c;b+=2)P[a.rawHeaders[b]]||(P[a.rawHeaders[b]]=[]),P[a.rawHeaders[b]].push(a.rawHeaders[b+1]||'');const b=a.request.timings;e({type:g.SIMULATOR_DEBUG_INFO,data:{method:'Network.responseReceived',params:{requestId:N,timestamp:Date.now()/1e3,type:'XHR',response:{url:L.url,status:a.statusCode,statusText:a.statusMessage,headers:z(P,'\n'),connectionId:N,timing:{requestTime:O/1e3,proxyStart:0,proxyEnd:b.socket,dnsStart:b.socket,dnsEnd:b.lookup,connectStart:b.lookup,connectEnd:b.connect,sslStart:-1,sslEnd:-1,workerStart:-1,workerReady:-1,sendStart:b.connect,sendEnd:b.connect,pushStart:0,pushEnd:0,receiveHeadersEnd:b.response},protocol:a.request.uri.protocol.replace(/:$/,'')+'/'+a.httpVersion}}}}),A.triggerOnEvent({eventName:'onDownloadTaskStateChange',data:{downloadTaskId:M,state:'headersReceived',header:z(P,','),cookies:y(P)}})}).on('error',function(a){a&&'EPROTO'===a.code?S({state:'fail',errMsg:o.config.TLS_VERSION_REQUIRED}):a&&('ETIMEDOUT'===a.code||'ESOCKETTIMEDOUT'===a.code)?S({state:'fail',errMsg:'timeout'}):S({state:'fail',errMsg:`${a}`}),e({type:g.SIMULATOR_DEBUG_INFO,data:{method:'Network.loadingFailed',params:{requestId:N,timestamp:Date.now()/1e3,type:'XHR',errorText:a.toString(),canceled:!1}}})}).on('data',(a)=>{k+=a.length,r.push(a),k>E?(S({state:'fail',errMsg:'exceed max file size'}),Q.abort()):T(k,R),e({type:g.SIMULATOR_DEBUG_INFO,data:{method:'Network.dataReceived',params:{requestId:N,timestamp:Date.now()/1e3,dataLength:a.length,encodedDataLength:a.length}}})}).on('abort',()=>{setTimeout(()=>{S({state:'fail',errMsg:'abort'})},0),e({type:g.SIMULATOR_DEBUG_INFO,data:{method:'Network.loadingFailed',params:{requestId:N,timestamp:Date.now()/1e3,type:'XHR',errorText:'abort',canceled:!0}}})}).on('end',(a)=>{a&&r.push(a);const b=Buffer.concat(r),d=j.initTmpfileName(B,b,C),f=j.getFileRealPath(d),h=f.fileRealPath;if(c.writeFileSync(h,b),c.unlinkSync(H),t.filePath){const a=j.rename(B,d,t.filePath);a.error?(S({state:'fail',errMsg:`permission denied, open "${t.filePath}"`,statusCode:x}),c.unlinkSync(d),c.unlinkSync(H),c.unlinkSync(h)):S({state:'success',filePath:t.filePath,header:z(P,','),cookies:y(P),statusCode:x})}else S({state:'success',tempFilePath:d,statusCode:x});e({type:g.SIMULATOR_DEBUG_INFO,data:{method:'Network.loadingFinished',params:{requestId:N,timestamp:Date.now()/1e3,dataLength:b.length,encodedDataLength:b.length}}}),n.set(N,h,'file')}).pipe(c.createWriteStream(H))}catch(a){return{errMsg:`${f.api}:fail ${a}`}}},operateDownloadTask:async function(a,b){const c=b.args,d=c.downloadTaskId,e=c.operationType,f=v[d];return f?'abort'==e?(f.request&&f.request.abort(),{errMsg:`${b.api}:ok`}):{errMsg:`${b.api}:fail illegal operationType`}:{errMsg:`${b.api}:fail task not found`}},resetNetworkStatus:function(){for(let a in t)try{t[a].request.abort()}catch(a){}for(let a in v)try{v[a].request.abort()}catch(a){}r=0,s=0,t={},v={}},checkNetworkAPIURL:async function(a,b){const{api:c,url:d}=b.args;if(!['request','websocket','downloadFile','uploadFile','udp'].includes(c))return{errMsg:`${b.api}:fail api = ${c} is not allowed`};if(d.endsWith(':'))return{errMsg:`${b.api}:fail bad url`};const e=/^(?:(?:(?:http|ws)s?)|udp):\/\/((?:\d{1,3}\.){3}\d{1,3})(?::\d{1,5})?/i;let g=!1,h=!1,i=!1;const j=f.getState().project.current.attr.network;let k=[];'request'===c?k=j.RequestDomain:'websocket'===c?k=j.WsRequestDomain:'downloadFile'===c?k=j.DownloadDomain:'uploadFile'===c?k=j.UploadDomain:void 0;for(let c=0;c<k.length;c++)if(k[c]===d){g=!0;break}if(e.test(d))try{let[a,b]=A();const c=e.exec(d)[1];if(c===a)h=!0,i=!0;else{const d=c.split('.').map((a,c)=>a&b[c]).join('.'),e=a.split('.').map((a,c)=>a&b[c]).join('.');d===e&&(i=!0)}}catch(a){}return{errMsg:`${b.api}:ok`,isInDomainList:g,isLocalHost:h,isInLAN:i}}}}(require('lazyload'),require);