;!function(require, directRequire){;'use strict';const React=require('react'),webdebuggerMessager=require('./e40e098fcb2111ba9f21e79c183fec7e.js'),appserviceMessager=require('./a1dd553cc059d528bb0ef56afed53968.js'),devtoolsMessager=require('./4762f28cad4425c4fc55dec009c87a7e.js'),webviewPool=require('./a78e6d6a87de1708226375ca4c320d76.js'),APP_ABOUT_BLANK='html/about.html',ABOUT_BLANK='about:blank',PopupWindow=require('./6620a0cf7dad1b400d60f0fdae40f524.js'),projectManager=require('./3bfffbe88b3d923921f851c0697974fe.js'),locales=require('./common/locales/index.js'),C=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),messageCenter=require('./ff946754202ecf377034d29daac7c8d9.js'),consoleDisplay=require('./2dfc6a3df6d6fc51266b293c8420e88b.js');class Webview extends React.Component{constructor(a){super(a),this.onMessage=(a)=>{const{command:b,data:c,webviewID:d,runtimeID:e}=a;if(d===this.webviewID)if('WEBDEBUGGER_INVOKE'===b){const{api:a,args:b,callbackID:d}=c;'invokeMiniProgramAPI'===a?(appserviceMessager.triggerOnEvent({eventName:'onWebInvokeAppService',data:{name:b.name,arg:b.arg,bitset:this.props.project&&this.props.project.runtimeAttr&&this.props.project.runtimeAttr.permissionBitset||''},webviewID:this.props.webviewID}),webdebuggerMessager.directSend({command:'WEBDEBUGGER_INVOKE_CALLBACK',data:{callbackID:d,res:{errMsg:'invokeMiniProgramAPI:ok'}}},e)):this.props.jssdkActions.exec(c,e)}else'WEBDEBUGGER_GET_TITLE_RES'===b&&this.props.updateHtmlWebview({webviewID:this.props.webviewID,htmlId:this.props.htmlId,documentTitle:c.title})},this.state={devtoolsShow:!1},this.devtoolsInited=!1,this.webviewID=''}componentDidMount(){this.initWebview(),webdebuggerMessager.register(this.onMessage)}componentWillReceiveProps(a){if((a.device!==this.props.device||a.height!==this.props.height)&&setTimeout(()=>{this.setWebviewInfo()}),a.act!==this.props.act){const b=this.props.act,c=a.act;setTimeout(()=>{this.doActions(c,b)})}this.props.nosupport||a.jssdkCallbackInfo===this.props.jssdkCallbackInfo||webdebuggerMessager.send({command:'WEBDEBUGGER_INVOKE_CALLBACK',data:a.jssdkCallbackInfo}),a.url!==this.props.url&&this.showDevTools(a.url),a.shareInfoShow!==this.props.shareInfoShow&&a.shareInfoShow&&this.webview.executeScript({code:'alert(\'GET_WEBVIEW_SCROLL_Y\' + window.scrollY);window.scrollTo(0,0);'},()=>{this.webview.captureVisibleRegion({format:'png'},(a)=>{this.props.simulatorActions.setShareDataURI(this.props.webviewID,a),this.webview.executeScript({code:`window.scrollTo(0,${this.webviewScrollY})`},()=>{this.webviewScrollY=void 0})})})}componentWillUnmount(){this.webview&&this.webview.detach(),this.devtoolsview&&this.devtoolsview.detach(),webdebuggerMessager.unRegister(this._onMessage)}doActions(a,b){const c=this.webview;return c?a.reload===b.reload?a.forward===b.forward?a.back===b.back?void(a.blank!==b.blank&&(c.src=APP_ABOUT_BLANK)):void(c.canGoBack()&&c.back()):void c.forward():void c.reload():void 0}initWebview(){const a=this.props,b=webviewPool.get('htmlwebview',{width:a.width,height:a.height,dpr:a.dpr});this.webview&&this.webview.detach(),this.webview=b,b.className=`simulator-bd-webview_body webviewbody htmlwebview${this.props.webviewID}`,this.setWebviewInfo(),this.initEvent();const c=webviewPool.get('devtools',{width:a.width,height:a.height,dpr:a.dpr}),d=`${c.originUserAgent} devtoolsview port/${global.messageCenterPort}`;c.setUserAgentOverride(d),c.on('dialog',(a)=>{a.preventDefault();const b=a.messageType,c=a.messageText,d=a.dialog;'prompt'===b&&(c===C.GET_MESSAGE_TOKEN?a.dialog.ok(messageCenter.getToken('HTMLWEBVIEWDEVTOOLS')):a.dialog.ok(''))}),this.devtoolsview&&this.devtoolsview.detach(),this.devtoolsview=c,this.devtoolsInited=!1,this.props.url&&this.showDevTools(this.props.url)}showDevTools(a){if(!this.webview||!this.devtoolsview||!a)return;const b=this.devtoolsview,c=this.webview;if(this.devtoolsInited)return void(c.src=a);const d=()=>{b.off('loadcommit',d);const e=()=>{c.off('loadcommit',e),c._webview.showDevTools(!0,b._webview),this.devtoolsInited=!0};c.on('loadcommit',e),c.src=a},e=()=>{b.off('contentload',e),this.setWebviewInfo()};b.on('loadcommit',d),b.on('contentload',e),b.src=ABOUT_BLANK,this.state.devtoolsShow?(b.setAttribute('style','height:100%;width:100%;display:block;'),b.attach(this.popupcontainer)):(b.setAttribute('style','height:1px;width:1px;display:block;'),b.attach(this.container)),c.attach(this.container)}initEvent(){const a=this.webview;this.props.nosupport||(a.onBeforeRequest=(a)=>{const{url:b,type:c}=a;if('main_frame'!==c&&'sub_frame'!==c)return{};if(/^chrome-extension:\/\//.test(b)||/^file:\/\//.test(b)||/favicon\.ico$/.test(b))return{};if(this.props.lastGetA8KeyUrl===b)return{};const d=/\#wechat_redirect$/.test(b);return this.props.debuggerActions.getWeappA8Key({url:b,isSync:d,from:'webviewrequest',htmlId:this.props.htmlId,webviewID:this.props.webviewID,redirectFromUrl:this.props.originUrl,appid:projectManager.getProjectAppID()}),/^https?:\/\//i.test(b)?{cancel:d}:{cancel:!0}},this.webview.onRequestBeforeSendHeaders=(a)=>{const b=a.url;return 0===b.indexOf(`http://127.0.0.1:${global.proxyPort}/`)||/favicon\.ico$/.test(b)||'none'!==this.props.networkType?void 0:(consoleDisplay.display({command:C.DISPLAY_ERROR,data:{title:locales.config.NO_NETWORK_TIPS_TITLE,error:{message:locales.config.NO_NETWORK_TIPS_CONTENT.format(b)}}}),{cancel:!0})}),a.on('loadstart',(a)=>{a.isTopLevel&&(this.loadingUrl=a.url||a.srcElement.src,this.triggerEvent('onWebviewStartLoad',{src:this.loadingUrl,htmlId:this.props.htmlId}),this.upWebviewStatus({loading:'start'}))}),a.onRequestCompleted=(a)=>{a.url===this.loadingUrl&&'main_frame'===a.type&&(!/^(200|3\d\d)$/.test(a.statusCode)&&this.triggerEvent('onWebviewError',{src:this.loadingUrl,htmlId:this.props.htmlId,errorCode:a.statusCode||0,description:a.statusLine||'',httpCode:a.statusCode}),this.triggerEvent('onWebviewFinishLoad',{src:this.loadingUrl,htmlId:this.props.htmlId}))},a.on('loadredirect',(a)=>{a.oldUrl===this.loadingUrl&&(this.loadingUrl=a.newUrl||a.srcElement.src,this.triggerEvent('onWebviewStartLoad',{src:this.loadingUrl,htmlId:this.props.htmlId}))}),a.on('loadcommit',(a)=>{a.isTopLevel&&this.upWebviewStatus({type:'loadcommit'})}),a.on('loadstop',()=>{this.upWebviewStatus({loading:'stop'}),webdebuggerMessager.send({command:'WEBDEBUGGER_GET_TITLE'})}),a.on('dialog',(a)=>{const b=a.messageType||'',c=a.messageText,d=a.dialog;if('alert'===b)0===c.indexOf('GET_WEBVIEW_SCROLL_Y')?this.webviewScrollY=c.replace('GET_WEBVIEW_SCROLL_Y',''):this.props.infoActions.setConfirmInfo({show:!0,showCancel:!1,content:c});else if('confirm'===b)a.preventDefault(),this.props.infoActions.setConfirmInfo({show:!0,showCancel:!0,content:c,callback:(a)=>{a?d.ok():d.cancel()}});else if('prompt'===b)if(c===C.GET_MESSAGE_TOKEN)d.ok(messageCenter.getToken('WEBDEBUGGER'));else{const a=prompt(c);null===a?d.cancel():d.ok(a)}}),a.on('mouseleave',()=>{devtoolsMessager.send({command:'SET_TOUCH_MODE',data:!1})}),a.on('mouseenter',()=>{devtoolsMessager.send({command:'SET_TOUCH_MODE',data:!0})});try{const b=new nw.Menu({type:'contextmenu'}),c=new nw.MenuItem({label:locales.config.DEBUG,id:void 0,click:()=>{this.setState({devtoolsShow:!0},()=>{this.initWebview()})}});b.append(c),a.on('contextmenu',(a)=>{a.preventDefault(),b.popup(a.pageX,a.pageY)},!0)}catch(a){}}triggerEvent(a,b){this.props.handleH5WebviewEvent&&this.props.handleH5WebviewEvent(a,b)}setWebviewInfo(){const a=this.props,b=this.webview,c=a.height/a.deviceScale,d=a.width/a.deviceScale;this.webviewID=`${a.htmlId}_${a.webviewID}`;const e=a.ua.replace('{{webviewID}}',this.webviewID);a.nosupport?(b.setUserAgentOverride(`${e} webdebugger port/${global.messageCenterPort}`),b.setAttribute('style',`position:absolute;height:${c}px;width:${d}px`),b.reload()):(b.setUserAgentOverride(`${e} webdebugger miniprogramhtmlwebview miniProgram port/${global.messageCenterPort}`),b.setAttribute('style',`position:absolute;height:${c}px;width:${d}px`),b.reload()),devtoolsMessager.send({command:'SET_DEVICE',data:{width:0,height:0,deviceScaleFactor:parseFloat(a.dpr),mobile:!0,fitWindow:!1,scale:1,screenHeight:parseInt(a.height,10),screenWidth:parseInt(a.width,10),positionX:0,positionY:0,screenOrientation:{angle:0,type:'portraitPrimary'}}})}upWebviewStatus(){const a=this.webview.canGoBack();this.props.cangoback!==a&&this.props.updateHtmlWebview({webviewID:this.props.webviewID,htmlId:this.props.htmlId,cangoback:a}),this.webview.src!==this.props.url&&this.props.debuggerActions.setUrl(this.webview.src)}onDevtoolsWindowClose(){this.setState({devtoolsShow:!1},()=>{this.initWebview()})}render(){const a={width:this.props.width/this.props.deviceScale,height:this.props.height/this.props.deviceScale,left:this.props.left,top:this.props.top,position:'absolute',zIndex:1};return React.createElement('div',{className:'webview',ref:(a)=>{this.container=a},style:a},this.state.devtoolsShow?React.createElement(PopupWindow,{title:locales.config.DEBUGGER,width:800,height:800,fullscreen:!1,always_on_top:!0,devtools:!0,onWindowClose:this.onDevtoolsWindowClose.bind(this),ref:(a)=>this.popupcontainer=a}):null)}}module.exports=Webview;
;}(require("lazyload"), require);
