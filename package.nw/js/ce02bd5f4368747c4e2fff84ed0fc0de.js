;!function(require, directRequire){;"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("tslib"),WebSocket=require("ws"),eventemitter3_1=require("eventemitter3"),child_process_1=require("child_process"),utils_1=require('./46d7303eb986fa402d60bf5e929aa077.js'),path=require("path"),{getNewTicket}=require('./89ba85d67a88f7636d657c22b5d3e038.js'),IOSPROXYPATH=utils_1.isDev?path.join(__dirname,"../../../../../bin/ios-remote-debug-proxy/WARemoteDebugProxy"):path.join(process.execPath,"../../../../../Resources/bin/ios-remote-debug-proxy/WARemoteDebugProxy"),log_1=require('./56a764ae9cb4336bf6babe1c1da0275b.js'),adb=require('./dd320c6b45ca97d2e34cfcab75e86aca.js'),index_1=require('./1c9e324c5ce9b5feb007c03bcb3f41dc.js'),config_1=require('./a148d3a11fd5268109e21fb40c9d527b.js');function clientRequestTypeForClientRequestCmd(a){return a}function sorterForDebugMessage(c,a){return c.seq-a.seq}exports.sorterForDebugMessage=sorterForDebugMessage;function httpUrlForClientRequestType(a){return a===config_1.ClientRequestType.Login?config_1.RemoteHttpUrlHost+"remote_wxlogin":a===config_1.ClientRequestType.JoinRoom?config_1.RemoteHttpUrlHost+"remote_wxjoinroom":a===config_1.ClientRequestType.QuitRoom?config_1.RemoteHttpUrlHost+"remote_wxquitroom":(utils_1.expectFail.fail(()=>{log.e("invalid request type",a,"for httpUrlForClientRequestType()")}),config_1.RemoteHttpUrlHost)}function httpUrlForDevtoolRequestType(a){return a===config_1.RequestType.JoinRoom?config_1.RemoteHttpUrlHost+"remote_devjoinroom":a===config_1.RequestType.QuitRoom?config_1.RemoteHttpUrlHost+"remote_devquitroom":(utils_1.expectFail.fail(()=>{log.e("invalid request type",a,"for httpUrlForDevtoolRequestType()")}),config_1.RemoteHttpUrlHost)}const __request=require('./15ba1827c7f6564a45df6bd44da3a977.js'),request=(a,b,c=!0)=>__request({needRandom:1,needToken:1,needAppID:1,needParse:1,needCheckErrCode:-1,needCheckStatusCode:1,method:"post",url:a,body:JSON.stringify(b||{})}),log=log_1.default("[wsserver]"),logInvoke=utils_1.logInvoke(log),logStack=utils_1.logStack(log);var DebugServerStatus;(function(a){a[a.Dead=-1]="Dead",a[a.Uninitialized=0]="Uninitialized",a[a.Connected=1]="Connected",a[a.InDebug=2]="InDebug"})(DebugServerStatus=exports.DebugServerStatus||(exports.DebugServerStatus={}));class DebugServer extends eventemitter3_1.EventEmitter{constructor(a){super(),this.wss=null,this.client=null,this.devtool=null,this.cpws=null,this.cp=null,this.androidDeviceId=void 0,this.clientProxyPort=void 0,this.status=0,this.transTicket="",this._httpRequesting=!1,this.archivedDebugMessages=[],this.managedSendAck=0,this.httpRequestQueue=[],this.inBytesCount=0,this.outBytesCount=0,global.ds=this,this.port=a.port,this.mode=a.mode||"server",this.androidDeviceId=a.androidDeviceId,this.clientProxyPort=a.clientProxyPort}setStatus(a){this.status=a,this.emit("statuschange")}async init(){this.setStatus(DebugServerStatus.Uninitialized),this.wss&&(log.w("reinit while wss exists"),this.client&&this.disconnectClient(404,"wsserver closed"),this.wss.removeAllListeners(),utils_1.tryCatch(()=>this.wss.close()),this.wss=null);const a=this.wss=new WebSocket.Server({perMessageDeflate:!1,port:this.port});a.on("connection",this.onWsConnection.bind(this)),a.on("error",this.onWssError.bind(this)),"ios"===this.mode?this.initCp():"android"===this.mode?await this.initAdb():log.i("server mode")}onCpError(a=!0){a?this.initCp():this.destroy()}async initAdb(){const a=await adb.version();log.i("adb version running",a);const b=this.androidDeviceId,c=this.clientProxyPort,d=this.port;await adb.reverse(b,`tcp:${c}`,`tcp:${d}`)}initCp(){if(this.cp){this.cp.removeAllListeners();try{this.cp.kill()}catch(a){}}const a=this.cp=child_process_1.spawn(IOSPROXYPATH,[`--wsurl=ws://localhost:${this.port}`,`--usbport=${this.clientProxyPort}`]);a.stdout&&a.stdout.setEncoding("utf8"),a.stdout&&a.stdout.on("data",(a)=>{console.log(a.toString())}),a.stderr&&a.stderr.on("data",(a)=>{console.warn(a.toString())}),a.on("disconnect",this.onCpError.bind(this,!1)),a.on("close",this.onCpError.bind(this,!1)),a.on("exit",(a)=>{log.w("cp exited with code "+a),this.onCpError(!1)}),a.on("error",(a)=>{log.e("cp encountered error",a.toString()),this.onCpError(!0)}),log.i("debugserver cp inited")}onWsConnection(a,b){if(!a)return void log.w("invalid connection",a);const c=a.protocol||b&&b.headers.protocol;return c&&"string"==typeof c?void("client"===c?(log.i("registered client"),this.client&&this.disconnectClient(301,"new client registered"),this.client=a,a.on("message",this.onClientWsMessage.bind(this)),this.onClientConnected()):"cp"===c?(log.i("registered cp"),this.cpws=a,a.on("message",this.onCpWsMessage.bind(this))):log.w("invalid protocol",c)):void log.w("invalid protocol",c)}onCpWsMessage(a){this.emit("cpmessage",a)}sendMessageToCp(a){this.cpws?this.cpws.send(a,(a)=>a&&log.e(a)):log.w("cp not ready sending messages")}setDevtool(a){this.devtool&&log.w("setting devtool while devtool exists"),this.devtool=a,this.onDevtoolSet()}onWssError(a){log.e("websocket server error",a),this.disconnectClient(500,"server error"),this.cpws&&(utils_1.tryCatch(()=>this.cpws.close(500,"server error")),this.cpws=null),this.restart()}restart(){this.disconnectClient(200,"server restart"),this.init()}onClientConnected(){this.devtool&&this.status>=DebugServerStatus.Uninitialized&&this.setStatus(DebugServerStatus.Connected),this.emit("clientready")}onDevtoolSet(){this.client&&this.status>=DebugServerStatus.Uninitialized&&this.setStatus(DebugServerStatus.Connected)}disconnectClient(a,b){this.client&&(500!==a&&200!==a&&this.devtoolQuitRoom(),utils_1.tryCatch(()=>this.client.removeAllListeners()),utils_1.tryCatch(()=>this.client.close(a,b))),this.client=null,this.status>DebugServerStatus.Uninitialized&&this.setStatus(DebugServerStatus.Uninitialized)}async devtoolJoinRoom(a=!0){if(this.status>DebugServerStatus.Connected&&log.w("devtool join room while status =",this.status),!this.devtool)return void log.e("devtool not ready join room",this.devtool);const b=this.devtool.getRoomInfo(),c={uri:httpUrlForDevtoolRequestType(config_1.RequestType.JoinRoom),room_id:b.room_id,wxpkg_info:b.wxpkg_info,appid:b.appid},d=await this.makeHttpRequest(c);return d.baseresponse&&d.baseresponse.errcode?void this.onErrorCode(d.baseresponse.errcode,a?this.devtoolJoinRoom.bind(this):void 0):void(d.ready&&this.onRemoteDebugReady())}async devtoolQuitRoom(){if(this.status<DebugServerStatus.Connected&&log.w("devtool quit room while status =",this.status),!this.devtool)return void log.e("devtool not ready quit room",this.devtool);const a={uri:httpUrlForDevtoolRequestType(config_1.RequestType.QuitRoom)};this.makeHttpRequest(a).catch(log.w);this.sendMessageToClient({},config_1.ClientResponseType.EventNotifyEnd,"debugserver-3002-client-"+Date.now()),this.onDebugEnd()}onDebugEnd(){this.client&&this.client.removeAllListeners(),this.client=null,this.devtool=null,this.emit("debugend"),this.destroy()}devtoolSendDebugMessages(a){this.archivedDebugMessages.push(...a),this.archivedDebugMessages.sort(sorterForDebugMessage);const b=[];let c=this.managedSendAck;for(const d of this.archivedDebugMessages)if(d.seq===c+1)b.push(d),++c;else if(d.seq<c+1)continue;else break;if(this.managedSendAck=c,!(1>b.length)){this.sendMessageToClient({debug_message:b},config_1.ClientResponseType.MessageNotifyParallelly,`debugserver-2006-client-${b[0].seq}-${b[b.length-1].seq}-${Date.now()}`)}}onRemoteDebugReady(){this.status<DebugServerStatus.Connected&&log.w("received debug ready while status =",this.status),this.setStatus(DebugServerStatus.InDebug),this.emit("remotedebugready");this.sendMessageToClient({},config_1.ClientResponseType.EventNotifyBegin,"debugserver-3001-client-"+Date.now())}onClientWsMessage(a){if("string"==typeof a){const b=parseInt(a,10),c=Date.now();return void log.i_("delta ===",c-b)}let b;if(!a)return log.w("received empty message from client ws",a),void log.f("<RECEIVED> <CLIENT> <EMPTY>  "+a);if(Buffer.isBuffer(a))b=a;else if("string"==typeof a)b=Buffer.from(a);else if(Buffer.isBuffer(a.data))b=a.data;else if("string"==typeof a.data)b=Buffer.from(a.data);else return log.w("received invalid message from client ws",a),void log.f("<RECEIVED> <CLIENT> <INVALID>  "+a);this.inBytesCount+=b.byteLength||0;const c=utils_1.tryCatch(()=>index_1.unwrapClientProtoToDataFormat(b));if(utils_1.invalidTryCatchResult(c)){const b={type:"receivedbrokenmessage",message:c.error.message};return this.emit("event",b),log.e("invalid client ws message",a,c.error.stack),void log.f("<RECEIVED CLIENT BROKEN>")}log.f("<RECEIVED CLIENT> {(cmd): "+c.cmd,", (uuid): "+c.uuid);const d=clientRequestTypeForClientRequestCmd(c.cmd);if(d===config_1.ClientRequestType.Login)log.i("client login"),this.onClientLogin(c.data,c);else if(d===config_1.ClientRequestType.Heartbeat)log.i("client heartbeat"),this.onClientHeartbeat(c.data,c);else if(d===config_1.ClientRequestType.JoinRoom)log.i("client join room"),this.onClientJoinRoom(c.data,c);else if(d===config_1.ClientRequestType.QuitRoom)log.i("client quit room"),this.onClientQuitRoom(c.data,c);else if(d===config_1.ClientRequestType.SyncMessage)log.i("client sync"),this.onClientSyncMessage(c.data,c);else if(d===config_1.ClientRequestType.SendDebugMessageParallelly)this.onClientSendDebugMessageParallelly(c.data,c);else{this.emit("event",{type:"receivedinvalidmessage"}),log.w("invalid client cmd",c.cmd,d)}}async onClientLogin(a,b){this.status<DebugServerStatus.Connected&&log.w("received client login while status < connected");const c=b.uuid||"",d={url:httpUrlForClientRequestType(config_1.ClientRequestType.Login),login_ticket:a.loginticket+""},e=await this.makeHttpRequest(d),f={base_response:{errcode:(e.baseresponse||{}).errcode||0,errmsg:(e.baseresponse||{}).errmsg||""}};if(this.devtool){const a=this.devtool.getRoomInfo();f.room_info=a,this.transTicket&&0<this.transTicket.length&&(f.room_info.join_room=!0)}else log.e("devtool not ready for room infos");this.transTicket=e.trans_ticket||"",this.sendMessageToClient(f,config_1.ClientResponseType.Login,c)}onClientHeartbeat(a,b){const c=b.uuid;this.sendMessageToClient({base_response:{errcode:0}},config_1.ClientResponseType.Heartbeat,c)}async onClientJoinRoom(a,b){const c=b.uuid,d={url:httpUrlForClientRequestType(config_1.ClientRequestType.JoinRoom),trans_ticket:this.transTicket,room_id:a.room_id,wxpkg_info:a.wxpkg_info};this.devtool&&(d.appid=this.devtool.getRoomInfo().appid);const e=await this.makeHttpRequest(d),f={base_response:{errcode:(e.baseresponse||{}).errcode||0,errmsg:(e.baseresponse||{}).errmsg||""}};this.sendMessageToClient(f,config_1.ClientResponseType.JoinRoom,c),e.ready&&this.onRemoteDebugReady()}async onClientQuitRoom(a,b){const c=b.uuid,d={url:httpUrlForClientRequestType(config_1.ClientRequestType.QuitRoom),trans_ticket:this.transTicket},e=await this.makeHttpRequest(d),f={base_response:{errcode:(e.baseresponse||{}).errcode||0,errmsg:(e.baseresponse||{}).errmsg||""}};this.sendMessageToClient(f,config_1.ClientResponseType.QuitRoom,c),this.onDebugEnd()}onClientSyncMessage(a,b){const c=b.uuid||"",d=this.archivedDebugMessages,e=a.min_seq,f=a.max_seq,g=[];if(e){const a=d.findIndex((a)=>a.seq===e);if(0<=a){const b=f?Math.min(d[d.length-1].seq,f):d[d.length-1].seq;for(let c=a;c<d.length;c++){const a=d[c];if(!(a.seq<=b&&a.seq>=e))break;else if(1>g.length||g[g.length-1].seq===a.seq+1)g.push(a);else{log.w("archivedDebugMessages seq error",g[g.length-1].seq,a.seq);continue}}}}const h={base_response:{errcode:0},debug_message:g};this.devtool&&this.devtool.receivedSeq&&(h.send_ack=this.devtool.receivedSeq),this.sendMessageToClient(h,config_1.ClientResponseType.SyncMessage,c)}onClientSendDebugMessageParallelly(a,b){const c=a.debug_message;if(c&&!(1>c.length)){const d=c[0].seq,e=c[c.length-1].seq,f=a.recv_ack;if(f){const a=this.archivedDebugMessages;this.archivedDebugMessages=[];for(const b of a)b.seq<=f||this.archivedDebugMessages.push(b)}const g=b.uuid||"";this.sendMessageToClient({base_response:{errcode:0},min_ack:d,max_ack:e},config_1.ClientResponseType.SendDebugMessageParallelly,g),this.emit("debugmessages",c)}}async makeHttpRequest(a={}){const b=a.url||a.uri||config_1.RemoteHttpUrlHost;log.f(`<HTTP REQUEST> ${b}, data = {${utils_1.tryCatch(()=>utils_1.jsonStringify(a))}}`);let c;delete a.uri,delete a.url;try{c=await request(b,a)}catch(a){return log.e("<HTTP REQUEST FAIL> "+b,a),{baseresponse:{errcode:config_1.KnownErrorCode.ERR_SYS,errmsg:"http request error"}}}if(!c||!c.body)throw log.e("invalid remote request response",c),new Error("invalid response");let d=c.body;return"string"==typeof d&&(d=utils_1.tryCatch(()=>utils_1.jsonParse(d)),utils_1.invalidTryCatchResult(d)&&(log.e("invalid raw result body",c,b),d=c.body)),log.i("http response result",b,a,d),d.baseresponse={errcode:parseInt(d.baseresponse.errcode,10),errmsg:(d.baseresponse.errmsg||"")+""},d}onErrorCode(a,b){const c={type:"receivederrorcode",errorCode:a,errorMessage:config_1.KnownErrorCode[a],message:"received error code "+a,kind:"error"};this.emit("event",c),config_1.KnownErrorCode.hasOwnProperty(a)&&(log.w("known error code",a),this.onKnownErrorCode(a,b))}async onKnownErrorCode(a,b){switch(a){case config_1.KnownErrorCode.USER_IN_DEBUGGING:{log.i("already in debugging"),await this.getRidOfRoom(),b&&b();break}default:}}async getRidOfRoom(){const a={uri:httpUrlForDevtoolRequestType(config_1.RequestType.QuitRoom)},b=await this.makeHttpRequest(a);log.i(b)}sendMessageToClient(a,b,c){if(!this.client)return void log.w("client not valid for sending messages");log.f("<SEND CLIENT> type: "+b+", uuid: "+c);const d=utils_1.tryCatch(()=>index_1.wrapClientResponseDataFormatToProto(a,b,c));return utils_1.invalidTryCatchResult(d)?void log.e("sending broken client response message",d.error.message):void utils_1.tryCatch(()=>{this.client.send(d,{binary:!0},(a)=>a&&log.e(a)),this.outBytesCount+=d.byteLength||0})}destroy(){if(!(this.status<=DebugServerStatus.Dead)){if(this.disconnectClient(101,"destroy"),this.devtool=null,this.cpws&&(utils_1.tryCatch(()=>this.cpws.close()),this.cpws=null),this.wss&&(this.wss.removeAllListeners(),utils_1.tryCatch(()=>this.wss.close()),this.wss=null),this.cp){this.cp.removeAllListeners();try{this.cp.kill()}catch(a){}this.cp=null}"android"===this.mode&&adb.kill().catch((a)=>log.w(a)),this.archivedDebugMessages=[],this.httpRequestQueue=[],this.transTicket="",this.setStatus(DebugServerStatus.Dead),this.emit("destroy")}}}tslib_1.__decorate([logInvoke],DebugServer.prototype,"setStatus",null),tslib_1.__decorate([logInvoke],DebugServer.prototype,"onCpError",null),tslib_1.__decorate([logInvoke],DebugServer.prototype,"initAdb",null),tslib_1.__decorate([logInvoke],DebugServer.prototype,"initCp",null),tslib_1.__decorate([logInvoke],DebugServer.prototype,"onWsConnection",null),tslib_1.__decorate([logInvoke],DebugServer.prototype,"onWssError",null),tslib_1.__decorate([logStack],DebugServer.prototype,"restart",null),tslib_1.__decorate([logInvoke],DebugServer.prototype,"onClientConnected",null),tslib_1.__decorate([logInvoke],DebugServer.prototype,"onDevtoolSet",null),tslib_1.__decorate([logInvoke],DebugServer.prototype,"onClientLogin",null),tslib_1.__decorate([logInvoke],DebugServer.prototype,"onClientJoinRoom",null),tslib_1.__decorate([logInvoke],DebugServer.prototype,"onClientQuitRoom",null),tslib_1.__decorate([logInvoke],DebugServer.prototype,"onClientSyncMessage",null),tslib_1.__decorate([logInvoke],DebugServer.prototype,"onClientSendDebugMessageParallelly",null),tslib_1.__decorate([logInvoke],DebugServer.prototype,"makeHttpRequest",null),tslib_1.__decorate([logInvoke],DebugServer.prototype,"onErrorCode",null),tslib_1.__decorate([logInvoke],DebugServer.prototype,"getRidOfRoom",null),exports.DebugServer=DebugServer;
;}(require("lazyload"), require);
