;!function(require, directRequire){;'use strict';const _=require('lodash'),path=require('path'),locales=require('./common/locales/index.js'),appErrcodeConfig=require('./949d8235c744ced2a80121e4dba34c28.js'),checkExtJSON=require('./551bb965e1f344281d555a429cd2140c.js'),checkAppJSON=require('./8267de7f4ec7b70a147f3fa5ef2bdea4.js'),contentWatcher=require('./162bf2ee28b76d3b3d95b685cede4146.js'),tools=require('./84b183688a46c9e2626d3e6f83365e13.js'),checkNodeModules=require('./fcadebce92dacc42ac4bba476b700dee.js'),compileCache=require('./2e9637e8a0816a626f7db9a0dee5efe8.js'),commonChecker=require('./464e9598eb5c203da6b41e702e422c70.js'),parseErr=require('./6238a86bb7a55c11aa0f9eb335d0f34c.js'),T=directRequire('./8a667b7a4c0cf964060daa2612e47d49.js'),validateType=directRequire('./2bf4b152a123cbd45f6c373678160abb.js'),workbenchStatusMessageHub=require('./879b9b1b8431c6089f7619a2530cf66d.js'),showWorkbenchStatus=(a,b)=>{const c={type:'SHOW',id:a,text:`compiling ${b}.json ...`,duration:Infinity};workbenchStatusMessageHub.hub.emit(workbenchStatusMessageHub.EVENT.STATUS_DISPLAY,c)},hideWorkbenchStatus=(a)=>{workbenchStatusMessageHub.hub.emit(workbenchStatusMessageHub.EVENT.STATUS_DISPLAY,{type:'HIDE',id:a})};async function checkPageJSON(a,b){const c=`${b}.json`;await compileCache.init(a);const d=await contentWatcher(a),e=compileCache.CACHE_KEYS.JSON_FILE,f=path.posix.join(d.srcPath,c),g=compileCache.get(e,f);if(g&&g.code&&g.nodeModules===a.setting.nodeModules)return _.cloneDeep(g.code);let h={},i='{}';const j=`${+new Date}-${Math.random()}`;showWorkbenchStatus(j,b);try{i=await d.getFileAsync(c)}catch(a){}try{h=JSON.parse(i)}catch(a){const d=parseErr.parseJsonParseErr({fileName:c,data:i,error:a}),e=new Error(d);throw e.path=b,e.code=appErrcodeConfig.PAGES_JSON_PARSE_ERR,hideWorkbenchStatus(j),e}try{validateType.check(h)}catch(a){const c=new Error(`${b}.json: pageJSON${a.message}`);throw c.path=b,c.code=appErrcodeConfig.PAGES_JSON_PARSE_ERR,hideWorkbenchStatus(j),c}const k=T.invalidKeys(validateType,h);if(k){const a=k.map((a)=>{return`pageJSON(${b})${a}`});h.__warning__=locales.config.INVALID.format(a.join('\u3001'))}const l=await checkExtJSON(a);l&&l.extPages&&l.extPages[b]&&(h=Object.assign({},h,l.extPages[b]));const m=[];if(h.backgroundColorTop&&(h.backgroundColor=h.backgroundColorTop),h.usingComponents&&commonChecker.checkUsingComponents(h,{msg:m,filePath:b,JSON_PARSE_ERR:appErrcodeConfig.PAGES_JSON_PARSE_ERR}),0<m.length){const a=new Error(m.join('\n'));throw a.path=b,a.code=appErrcodeConfig.PAGES_JSON_PARSE_ERR,hideWorkbenchStatus(j),a}const n=await checkAppJSON(a);if(n.usingComponents&&!b.startsWith('miniprogram_npm'))for(const c in h.usingComponents||(h.usingComponents={}),n.usingComponents){if(h.usingComponents[c])continue;const e=n.usingComponents[c]||'',f=a.miniprogramRoot?tools.normalizePath(a.miniprogramRoot):'.',g=a.miniprogramRoot?path.join(a.projectpath,f):a.projectpath;if(!e.startsWith('/')&&!e.startsWith('plugin://')){const a=path.resolve(g,e),i=path.dirname(path.resolve(g,b)),j=path.relative(i,a);if(e.startsWith('.'))h.usingComponents[c]=tools.normalizePath(j);else if(!d.exists(a)){const a=await checkNodeModules.resolveComponentPath(d,f,e);h.usingComponents[c]=a?tools.normalizePath(path.relative(b,a)):tools.normalizePath(j)}else h.usingComponents[c]=tools.normalizePath(j)}else h.usingComponents[c]=n.usingComponents[c]}return a.setting&&a.setting.nodeModules&&(await checkNodeModules.checkComponentPath(d,h,b)),compileCache.set(e,f,{code:h,nodeModules:a.setting.nodeModules}),hideWorkbenchStatus(j),_.cloneDeep(h)}module.exports=checkPageJSON;
;}(require("lazyload"), require);
